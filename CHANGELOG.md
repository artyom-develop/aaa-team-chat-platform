# Изменения в системе видеоконференций

## Дата: 16 февраля 2026

### 1. Исправлена проблема с пропаданием видео при обновлении страницы

**Проблема:** При обновлении страницы (F5) у гостя пропадало видео и WebRTC соединения не восстанавливались.

**Решение:**
- Добавлено событие `room:request-offers` на сервере, которое уведомляет переподключившегося пользователя о необходимости создать WebRTC-соединения со всеми участниками
- Улучшена логика создания peer connections - теперь автоматически пересоздаются соединения в состоянии 'closed' или 'failed'
- Добавлена более надежная обработка переподключений в useWebRTC

**Файлы:**
- `server/src/socket/handlers/room.handler.ts` - добавлено событие request-offers
- `client/src/hooks/useSocket.ts` - добавлен обработчик room:request-offers
- `client/src/hooks/useWebRTC.ts` - улучшена логика создания peer connections

### 2. Улучшен UI - добавлен режим просмотра как в Zoom

**Новые возможности:**
- **Spotlight View (режим по умолчанию):** 
  - Главное видео показывается на весь экран (по умолчанию - хост комнаты)
  - Остальные участники отображаются в виде превью внизу экрана
  - Клик по превью переключает главное видео
  - Индикатор хоста в имени участника

- **Grid View (классический режим):**
  - Все участники отображаются в сетке
  - Автоматическое определение количества колонок (1-4) в зависимости от числа участников

- **Переключение режимов:**
  - Кнопки в правом верхнем углу для переключения между Spotlight и Grid
  - Иконки Grid (сетка) и Users (спотлайт)

**Файлы:**
- `client/src/store/videoLayoutStore.ts` - новый store для управления layout
- `client/src/components/room/VideoGrid.tsx` - полностью переработан компонент
- `client/src/components/room/VideoTile.tsx` - добавлены режимы spotlight и thumbnail

**Особенности:**
- Автоматический выбор хоста как главного видео при входе в комнату
- Hover-эффект на превью для лучшей интерактивности
- Адаптивные размеры элементов в зависимости от режима отображения
- Плавные переходы и анимации

## Как использовать

1. **Spotlight View:**
   - По умолчанию активен при входе в комнату
   - Хост отображается как главное видео
   - Кликните на любого участника в превью внизу, чтобы сделать его главным

2. **Grid View:**
   - Нажмите кнопку с иконкой сетки в правом верхнем углу
   - Все участники отображаются равномерно

3. **Переподключение:**
   - Теперь можно обновлять страницу (F5) без потери видео
   - WebRTC соединения автоматически восстанавливаются

## Технические детали

- WebRTC peer connections теперь автоматически пересоздаются при плохом состоянии соединения
- Добавлена проверка состояния соединения перед созданием новых offers
- Улучшена обработка ICE candidates
- Spotlight participant выбирается автоматически при входе (приоритет - хост)
