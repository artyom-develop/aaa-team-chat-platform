# Владелец проекта

- Имя: artyom-develop
- Email: artem2006pax@mail.ru

---

# Инструкции по тестированию WebRTC соединений

## Что исправлено:

### 1. ICE Candidate Errors - теперь фильтруются
- **Раньше**: Каждый STUN timeout показывался как ошибка в console.error
- **Сейчас**: STUN timeouts (errorCode 701) не логируются - это нормальная часть процесса установки соединения
- **Результат**: Чистая консоль, только реальные проблемы показываются

### 2. Отключение камеры/микрофона
- **Раньше**: Могло вызывать разрыв соединения
- **Сейчас**: 
  - Только меняется `track.enabled` (без renegotiation)
  - Stream ID остается тем же
  - WebRTC соединение не пересоздается
- **Логи для проверки**: Смотрите в консоли `[mediaStore] toggleVideo:` и `[mediaStore] toggleAudio:`

### 3. Переподключение при перезагрузке страницы
- **Раньше**: Соединения не восстанавливались
- **Сейчас**:
  - Socket.io автоматически переподключается
  - Старые participants очищаются перед добавлением новых
  - WebRTC соединения пересоздаются для всех участников
- **Логи для проверки**: `[useSocket] Detected reconnect - clearing old participants`

### 4. Умное переподключение WebRTC
- **disconnected** → ждет 10 секунд перед разрывом (ICE может восстановиться)
- **ICE disconnected** → ждет 5 секунд перед ICE restart
- **failed** → немедленно пытается переподключиться через 2 секунды

## Что смотреть в консоли:

### При отключении камеры/микрофона:
```
[mediaStore] toggleVideo: { from: true, to: false, streamId: "xxx", ... }
[mediaStore] Setting video track enabled: { trackId: "yyy", enabled: false, ... }
```
**Важно**: `streamId` НЕ должен меняться!

### При переподключении:
```
[useSocket] Detected reconnect - clearing old participants
[useWebRTC] ===== Participants/Stream changed, checking connections =====
[useWebRTC] Creating offer for new participant: xxx
```

### При установке соединения:
```
[useWebRTC] ICE connection state for xxx: connected
[useWebRTC] PeerConnection state for xxx: connected
### Реальные проблемы:
- `ICE connection failed` - критично, будет автоматически переподключаться
- `Connection failed` - критично, покажет toast с ошибкой

## Как тестировать:

1. **Тест отключения камеры**:
   - Откройте консоль (F12)
   - Нажмите кнопку отключения камеры
   - Проверьте что `streamId` не изменился  
   - Соединение должно остаться активным (`PeerConnection state: connected`)

2. **Тест перезагрузки страницы**:
   - Подключитесь к комнате с другим пользователем
   - Нажмите F5 (перезагрузка)
   - Должны увидеть: `Detected reconnect` → очистка → создание новых соединений
   - Видео/аудио должны восстановиться

3. **Тест переподключения при плохой сети**:
   - В DevTools → Network → Throttling выберите "Slow 3G"
   - Соединение может перейти в `disconnected`
   - Должно автоматически восстановиться через несколько секунд

## Ожидаемое поведение:

✅ Камера/микрофон отключаются без разрыва соединения
✅ Перезагрузка страницы восстанавливает все соединения
✅ Плохая сеть вызывает автоматическое переподключение
✅ Минимум ошибок в консоли
✅ Toast уведомления только для реальных проблем
